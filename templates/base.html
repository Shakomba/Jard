<!doctype html>
<html lang="{{ 'ckb' if lang == 'ku' else 'en' }}" dir="{{ 'rtl' if lang == 'ku' else 'ltr' }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no,email=no,address=no" />
  <meta name="theme-color" content="#0A0A0F" />
  <title>{{ title or t('app.name') }}</title>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">

  <script>
    (function () {
      const stored = localStorage.getItem('theme');
      if (stored === 'light' || stored === 'dark') {
        document.documentElement.setAttribute('data-theme', stored);
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        if (themeMeta) {
          themeMeta.setAttribute('content', stored === 'light' ? '#f8fafc' : '#0A0A0F');
        }
      }
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg: #0A0A0F;
      --bg-elev-1: #0F1017;
      --bg-elev-2: #12121B;
      --bg-elev-3: #171725;

      --border: rgba(255, 255, 255, 0.10);
      --divider: rgba(255, 255, 255, 0.07);

      --text: #F2F3F7;
      --text-2: #B7BAC7;
      --text-3: #7D8196;

      --accent: #8B5CF6;
      --accent-soft: rgba(139, 92, 246, 0.14);
      --accent-border: rgba(139, 92, 246, 0.28);
      --focus: rgba(139, 92, 246, 0.35);

      /* Kept for existing code that references it */
      --page-bg: var(--bg);
    }
    :root[data-theme="light"] {
      --page-bg: #f8fafc;
    }
    html,
    body {
      background-color: var(--page-bg);
      margin: 0;
      padding: 0;
    }
    html {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    
    /* Override RTL for member profiles - keep them LTR */
    html[lang="ckb"] .soft.rounded-2xl,
    html[lang="ckb"] .soft.rounded-3xl {
      direction: ltr;
    }
    
    /* Navbar: always keep LTR layout */
    html[dir="rtl"] #appHeader,
    html[dir="rtl"] #appHeader * {
      direction: ltr;
    }
    
    /* But allow nav text to be RTL */
    html[dir="rtl"] #topNav a,
    html[dir="rtl"] #topNav button {
      direction: rtl;
    }

    /* Always keep password inputs LTR (field only, not labels). */
    input[type="password"],
    input[type="password"]::placeholder {
      direction: ltr;
      text-align: left;
      unicode-bidi: plaintext;
    }

    /* Nudge field labels inward: right in LTR, left in RTL. */
    label.text-slate-200:not(.flex):not(.inline-flex):not(.absolute),
    form label:not(.flex):not(.inline-flex):not(.absolute) {
      padding-inline-start: 0.35rem;
    }
    
    body {
      background:
        radial-gradient(900px circle at 50% -20%, rgba(139, 92, 246, 0.10), transparent 55%),
        linear-gradient(135deg, var(--bg) 0%, var(--bg) 100%);
      color: var(--text);
      font-family: "Vazirmatn", "Noto Naskh Arabic", "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: pan-y;
      margin: 0;
      padding: 0;
    }
    
    /* Mobile bottom nav spacing */
    @media (max-width: 640px) {
      body:not(.no-mobile-padding) {
        padding-bottom: 80px;
      }
      /* Reduce backdrop-filter on mobile for better performance */
      .card {
        backdrop-filter: blur(8px);
      }
      .header-shell {
        backdrop-filter: blur(8px);
      }
    }

    /* Map common Tailwind text utilities to the palette (dark mode). */
    .text-slate-100 { color: var(--text) !important; }
    .text-slate-200 { color: var(--text-2) !important; }
    .text-slate-300 { color: var(--text-2) !important; }
    .text-slate-400 { color: var(--text-3) !important; }
    .card {
      backdrop-filter: blur(16px);
      background: rgba(18, 18, 27, 0.75);
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.2);
      transform: none;
    }
    .or-divider-bg {
      background: rgba(18, 18, 27, 0.75);
    }
    .header-shell {
      backdrop-filter: blur(12px);
      background: rgba(15, 16, 23, 0.75);
      border: 1px solid rgba(255,255,255,0.08);
      will-change: backdrop-filter;
    }
    
    /* Mobile bottom navigation */
    @media (max-width: 640px) {
      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        backdrop-filter: blur(12px);
        background: rgba(15, 16, 23, 0.95);
        border-top: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        padding: 0.5rem 0;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
      }
      .mobile-bottom-nav nav {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.25rem;
        padding: 0 0.5rem;
      }
      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        border-radius: 1rem;
        transition: all 0.2s ease;
        position: relative;
        text-decoration: none;
      }
      .mobile-nav-item svg {
        width: 1.5rem;
        height: 1.5rem;
        margin-bottom: 0.25rem;
        transition: transform 0.2s ease;
      }
      .mobile-nav-item span {
        font-size: 0.65rem;
        font-weight: 500;
      }
      .mobile-nav-item.active {
        background: rgba(139, 92, 246, 0.15);
      }
      .mobile-nav-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 32px;
        height: 3px;
        background: var(--accent);
        border-radius: 0 0 3px 3px;
      }
      .mobile-nav-item.active svg {
        color: var(--accent);
        transform: scale(1.1);
      }
      .mobile-nav-item:not(.active):hover {
        background: rgba(255, 255, 255, 0.05);
      }
      
      /* Hide entire header on mobile */
      #appHeader {
        display: none !important;
      }
      
      #topNav {
        display: none !important;
      }
    }
    
    /* Desktop nav improvements */
    @media (min-width: 641px) {
      .mobile-bottom-nav {
        display: none;
      }
    }

    /* Desktop top nav: SPA sets `.active` class; style it here. */
    #topNav a.active {
      background: rgba(139, 92, 246, 0.15);
      box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.20);
    }
    #topNav a.active:hover {
      background: rgba(139, 92, 246, 0.18);
    }
    :root[data-theme="light"] #topNav a.active {
      background: rgba(139, 92, 246, 0.12);
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.22);
    }
    :root[data-theme="light"] #topNav a.active:hover {
      background: rgba(139, 92, 246, 0.16);
    }
    
    #appHeader {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .header-shell.docked {
      top: 0 !important;
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
      border-bottom-left-radius: 1.5rem !important;
      border-bottom-right-radius: 1.5rem !important;
    }
    #appHeaderSpacer {
      transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 2.5rem;
    }
    .soft {
      background: rgba(15, 16, 23, 0.60);
      border: 1px solid rgba(255,255,255,0.10);
      transform: translateZ(0);
    }
    .input {
      background: rgba(18, 18, 27, 0.85);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      text-align: start;
      transition: all 0.2s ease;
    }

    /* Custom select arrow utility: hides native arrow and draws a small SVG arrow
       positioned slightly inset. Respects RTL by switching to left. */
    .select-arrow {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%23B7BAC7' stroke-width='1.6'><path stroke-linecap='round' stroke-linejoin='round' d='M6 8l4 4 4-4'/></svg>");
      background-repeat: no-repeat;
      background-position: right 0.9rem center;
      background-size: 1rem;
      padding-right: 2.25rem;
    }
    html[dir="rtl"] .select-arrow {
      background-position: left 0.9rem center;
      padding-left: 2.25rem;
      padding-right: 0.75rem;
    }

    /* Beautiful dropdown options styling */
    select option {
      background: var(--bg-elev-2);
      color: var(--text);
      padding: 0.75rem 1rem;
      border: none;
    }
    select option:hover {
      background: var(--accent-soft);
      color: var(--text);
    }
    select option:checked,
    select option:selected {
      background: var(--accent);
      color: white;
      font-weight: 500;
    }

    /* Custom dropdown component */
    .custom-select {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .custom-select-button {
      width: 100%;
      padding: 0.75rem 3rem 0.75rem 1rem;
      background: rgba(18, 18, 27, 0.85);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 1rem;
      color: var(--text);
      text-align: left;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }
    html[dir="rtl"] .custom-select-button {
      text-align: right;
      padding: 0.75rem 1rem 0.75rem 3rem;
    }
    .custom-select-button:hover {
      background: rgba(18, 18, 27, 0.95);
      border-color: rgba(255,255,255,0.18);
    }
    .custom-select-button:focus,
    .custom-select-button.open {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus);
    }
    .custom-select-arrow {
      position: absolute;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      transition: transform 0.2s ease;
      color: var(--text-3);
      pointer-events: none;
    }
    html[dir="rtl"] .custom-select-arrow {
      right: auto;
      left: 1rem;
    }

    
    .custom-select-button.open .custom-select-arrow {
      transform: translateY(-50%) rotate(180deg);
    }
    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 9999;
      margin-top: 0.25rem;
      background: rgba(18, 18, 27, 0.98);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 4px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(20px);
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
      transition: all 0.2s ease;
      pointer-events: none;
      max-height: 200px;
      overflow-y: auto;
    }
    /* RTL adjustments: align options and ensure dropdown text reads correctly in RTL pages */
    html[dir="rtl"] .custom-select-dropdown {
      text-align: right;
      direction: rtl;
    }
    .custom-select-dropdown.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .custom-select-option {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background-color 0.1s ease;
      color: var(--text);
      border-radius: 0;
    }
    .custom-select-option:first-child {
      border-radius: 1rem 1rem 0 0;
    }
    .custom-select-option:last-child {
      border-radius: 0 0 1rem 1rem;
    }
    .custom-select-option:hover {
      background: var(--accent-soft);
    }
    .custom-select-option.selected {
      background: var(--accent);
      color: white;
      font-weight: 500;
    }
    .input:focus {
      background: rgba(18, 18, 27, 0.95);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus);
    }
    .input::placeholder { color: rgba(183, 186, 199, 0.70); }
    /* When the page is RTL but an auth card is forced to LTR, ensure inputs sit tight to the left edge
       and keep space on the right for the show-password button. */
    html[dir="rtl"] .card[dir="ltr"] .input,
    html[dir="rtl"] .card[dir="ltr"] input.input {
      direction: ltr !important;
      text-align: left !important;
      padding-left: 0.75rem !important;
      padding-right: 3.25rem !important;
    }
a[href^="mailto"],
    a[x-apple-data-detectors],
    a[x-apple-data-detectors-type="email"] {
      color: inherit !important;
      text-decoration: none !important;
    }
    .menu-panel {
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      background: rgba(18, 18, 27, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      will-change: opacity, transform;
      -webkit-transform: translateY(-8px) scale(0.98);
    }
.menu-panel.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .menu-backdrop {
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .menu-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }


    button {
      transition: transform .15s ease, box-shadow .15s ease;
    }
    button:hover:not(:disabled):not(.no-hover) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    button:active:not(:disabled):not(.no-hover) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Floating Action Button */
    .fab {
      position: fixed !important;
      bottom: 90px !important;
      right: 1rem !important;
      z-index: 40 !important;
      width: 56px !important;
      height: 56px !important;
      border-radius: 50% !important;
      background: linear-gradient(135deg, var(--accent), #a855f7) !important;
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4), 0 2px 8px rgba(0,0,0,0.3) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none !important;
      cursor: pointer !important;
    }
    .fab:hover {
      transform: scale(1.1) translateY(-2px) !important;
      box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5), 0 4px 12px rgba(0,0,0,0.4) !important;
    }
    .fab:active {
      transform: scale(0.95) !important;
    }
    /* Utility to disable scrolling when page content fits viewport */
    html.no-scroll, body.no-scroll {
      overflow: hidden !important;
      height: 100% !important;
    }
    /* Expense form visibility - prevent layout shift */
    #desktopExpenseForm {
      display: none;
    }
    @media (min-width: 641px) {
      .fab {
        display: none !important;
      }
      #expenseModal {
        display: none !important;
      }
      #desktopExpenseForm {
        display: block;
      }
    }
    :root[data-theme="light"] body {
      background:
        radial-gradient(900px circle at 15% 5%, rgba(99, 102, 241, 0.12), transparent 45%),
        radial-gradient(800px circle at 85% 0%, rgba(236, 72, 153, 0.10), transparent 50%),
        linear-gradient(135deg, #e2e8f0 0%, #e7e5e4 45%, #f1e7f0 100%) !important;
      color: #0f172a;
    }
    :root[data-theme="light"] html,
    :root[data-theme="light"] body {
      background:
        radial-gradient(1200px circle at 50% -15%, rgba(139, 92, 246, 0.06), transparent 60%),
        radial-gradient(800px circle at 80% 100%, rgba(236, 72, 153, 0.04), transparent 50%),
        linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    }
    :root[data-theme="light"] .card {
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 4px 24px rgba(15, 23, 42, 0.06), 0 2px 8px rgba(15, 23, 42, 0.03);
    }
    :root[data-theme="light"] .or-divider-bg {
      background: #ffffff;
    }
    :root[data-theme="light"] .header-shell {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.04);
    }
    :root[data-theme="light"] .mobile-bottom-nav {
      background: rgba(255, 255, 255, 0.98);
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 -4px 20px rgba(15, 23, 42, 0.05);
    }
    :root[data-theme="light"] .mobile-nav-item:not(.active):hover {
      background: rgba(15, 23, 42, 0.05);
    }
    :root[data-theme="light"] .menu-panel {
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.08), 0 4px 16px rgba(15, 23, 42, 0.04);
    }
    :root[data-theme="light"] .soft {
      background: rgba(241, 245, 249, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }
    :root[data-theme="light"] .custom-select-button {
      background: #ffffff;
      border: 1.5px solid rgba(148, 163, 184, 0.3);
      color: #0f172a;
    }
    :root[data-theme="light"] .custom-select-button:hover {
      background: #f8fafc;
      border-color: rgba(148, 163, 184, 0.4);
    }
    :root[data-theme="light"] .custom-select-button:focus,
    :root[data-theme="light"] .custom-select-button.open {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    :root[data-theme="light"] .custom-select-dropdown {
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.08), 0 4px 16px rgba(15, 23, 42, 0.04);
    }
    :root[data-theme="light"] .custom-select-option {
      color: #0f172a;
    }
    :root[data-theme="light"] .custom-select-option:hover {
      background: rgba(139, 92, 246, 0.08);
    }
    :root[data-theme="light"] .custom-select-option.selected {
      background: var(--accent);
      color: white;
    }
    :root[data-theme="light"] .input {
      background: #ffffff;
      border: 1.5px solid rgba(148, 163, 184, 0.3);
      color: #0f172a;
    }
    :root[data-theme="light"] .input:focus {
      background: #ffffff;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    :root[data-theme="light"] .input::placeholder { color: rgba(100, 116, 139, 0.6); }

    :root[data-theme="light"] .text-slate-100 { color: #0f172a !important; }
    :root[data-theme="light"] .text-slate-200 { color: #1e293b !important; }
    :root[data-theme="light"] .text-slate-300 { color: #475569 !important; }
    :root[data-theme="light"] .text-slate-400 { color: #64748b !important; }
    :root[data-theme="light"] .text-slate-500 { color: #94a3b8 !important; }
    :root[data-theme="light"] .text-violet-200 { color: #7c3aed !important; }
    :root[data-theme="light"] .text-violet-300 { color: #6d28d9 !important; }
    :root[data-theme="light"] .text-rose-300 { color: #e11d48 !important; }
    :root[data-theme="light"] .text-emerald-300 { color: #059669 !important; }
    :root[data-theme="light"] .text-emerald-400 { color: #10b981 !important; }
    :root[data-theme="light"] .text-rose-400 { color: #f43f5e !important; }
    :root[data-theme="light"] .admin-warning-text { color: #d97706 !important; }
    :root[data-theme="light"] .admin-label {
      background: rgba(245, 158, 11, 0.15) !important;
      color: #d97706 !important;
    }
    :root[data-theme="light"] .household-code {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(168, 85, 247, 0.08)) !important;
      border-color: rgba(139, 92, 246, 0.25) !important;
      color: #6d28d9 !important;
    }

    /* Purple buttons should have white text in light mode */
    :root[data-theme="light"] .bg-violet-500,
    :root[data-theme="light"] .bg-violet-400,
    :root[data-theme="light"] .bg-violet-600,
    :root[data-theme="light"] button.bg-violet-500,
    :root[data-theme="light"] button.bg-violet-400,
    :root[data-theme="light"] button.bg-violet-600,
    :root[data-theme="light"] .hover\:bg-violet-400:hover,
    :root[data-theme="light"] .hover\:bg-violet-500:hover {
      color: #ffffff !important;
    }

    :root[data-theme="light"] .bg-white\/5 { background-color: rgba(15, 23, 42, 0.03) !important; }
    :root[data-theme="light"] .bg-white\/10 { background-color: rgba(15, 23, 42, 0.06) !important; }
    :root[data-theme="light"] .bg-white\/15 { background-color: rgba(15, 23, 42, 0.09) !important; }
    :root[data-theme="light"] .bg-black\/20 { background-color: rgba(15, 23, 42, 0.08) !important; }
    :root[data-theme="light"] .bg-black\/30 { background-color: rgba(15, 23, 42, 0.15) !important; }
    :root[data-theme="light"] .bg-black\/40 { background-color: rgba(15, 23, 42, 0.2) !important; }
    :root[data-theme="light"] .bg-black\/70 { background-color: rgba(15, 23, 42, 0.5) !important; }
    :root[data-theme="light"] .bg-black\/50 { background-color: rgba(15, 23, 42, 0.3) !important; }
    :root[data-theme="light"] .bg-violet-500\/20 { background-color: rgba(139, 92, 246, 0.15) !important; }
    :root[data-theme="light"] .bg-violet-500\/30 { background-color: rgba(139, 92, 246, 0.2) !important; }

    :root[data-theme="light"] .border-white\/10 { border-color: rgba(148, 163, 184, 0.2) !important; }
    :root[data-theme="light"] .border-white\/20 { border-color: rgba(148, 163, 184, 0.3) !important; }
    :root[data-theme="light"] .border-violet-400\/30 { border-color: rgba(139, 92, 246, 0.3) !important; }
    :root[data-theme="light"] .ring-white\/10 { --tw-ring-color: rgba(148, 163, 184, 0.25) !important; }
    :root[data-theme="light"] .ring-white\/15 { --tw-ring-color: rgba(148, 163, 184, 0.35) !important; }
    :root[data-theme="light"] .ring-rose-400\/40 { --tw-ring-color: rgba(251, 113, 133, 0.4) !important; }
    :root[data-theme="light"] .ring-emerald-400\/40 { --tw-ring-color: rgba(52, 211, 153, 0.4) !important; }
    :root[data-theme="light"] .ring-violet-400\/60 { --tw-ring-color: rgba(167, 139, 250, 0.5) !important; }

    .ltr {
      direction: ltr;
      unicode-bidi: embed;
    }
    .text-start { text-align: start; }
    .text-end { text-align: end; }

    /* Theme-aware logo switching */
    .dark-logo { display: block; }
    .light-logo { display: none; }
    :root[data-theme="light"] .dark-logo { display: none; }
    :root[data-theme="light"] .light-logo { display: block; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Page transition animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    #appMain > div {
      animation: fadeInUp 0.4s ease-out;
    }
    
    /* Skeleton loading state */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Improved scrollbar for webkit browsers */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(139, 92, 246, 0.3) rgba(255, 255, 255, 0.05);
    }

    /* Mobile performance optimizations */
    @media (max-width: 640px) {
      * {
        -webkit-tap-highlight-color: transparent;
      }

      /* Use GPU acceleration for animations on mobile */
      .card, .soft, .mobile-nav-item, button {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }

      /* Fix background to prevent repaint on scroll */
      body {
        background-attachment: fixed;
      }
    }
    
    *::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    *::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    
    *::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 4px;
    }
    
    *::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }
  
  </style>
</head>

{% set ep = request.endpoint or "" %}
{% set is_auth_page = ep in ["login", "register", "register_verify", "register_profile", "forgot_password", "reset_password", "verify_required"] %}
{% set hide_navbar = ep in ["login", "register", "register_verify", "register_profile", "forgot_password", "reset_password", "verify_required"] %}

<body class="min-h-screen text-slate-100{% if hide_navbar %} no-mobile-padding{% endif %}">
  <div id="appRoot" class="{% if not hide_navbar %}max-w-7xl mx-auto px-4 {% if is_auth_page %}pt-12 pb-6{% else %}pb-3{% endif %}{% endif %}" style="overflow: visible;">
    {% set next_lang = "en" if lang == "ku" else "ku" %}
    {% if not hide_navbar %}
    <header id="appHeader" class="{% if is_auth_page %}fixed inset-x-0 top-0 bg-[var(--bg)]/95 backdrop-blur-sm border-b border-white/5 px-4 py-4{% else %}app-header-fixed fixed top-3 left-1/2 -translate-x-1/2 header-shell rounded-3xl px-4 py-3 sm:px-6{% endif %} z-50" style="overflow: visible; {% if not is_auth_page %}width: min(80rem, calc(100vw - 2rem));{% endif %}">
      <div class="{% if is_auth_page %}flex flex-col items-center text-center gap-2{% else %}flex flex-col gap-4 sm:grid sm:grid-cols-[auto,1fr,auto] sm:items-center{% endif %}">
        {% if is_auth_page and not hide_navbar and ep != 'forgot_password' %}
            <div class="flex items-center justify-center gap-3">
              <div class="h-12 w-12">
                <img src="{{ url_for('static', filename='LogoDark.png') }}" alt="{{ t('common.logo') }}" class="h-full w-full object-contain dark-logo transform scale-150 origin-center">
                <img src="{{ url_for('static', filename='LogoLight.png') }}" alt="{{ t('common.logo') }}" class="h-full w-full object-contain light-logo hidden transform scale-150 origin-center">
              </div>
            </div>
        {% else %}
          <div class="flex items-center justify-between w-full sm:contents">
            <a href="{{ url_for('dashboard') }}" class="flex items-center justify-start gap-3 text-start sm:col-start-1 sm:row-start-1">
              <div class="h-12 w-12 ml-3">
                <img src="{{ url_for('static', filename='LogoDark.png') }}" alt="{{ t('common.logo') }}" class="h-full w-full object-contain dark-logo transform scale-150 origin-center">
                <img src="{{ url_for('static', filename='LogoLight.png') }}" alt="{{ t('common.logo') }}" class="h-full w-full object-contain light-logo hidden transform scale-150 origin-center">
              </div>
            </a>
            {% if current_user.is_authenticated %}
              <div class="flex items-center gap-1.5 sm:col-start-3 sm:row-start-1 sm:justify-self-end">
                <!-- Language Toggle -->
                <form id="langForm" method="post" action="{{ url_for('set_language') }}" class="inline">
                  <input type="hidden" name="lang" value="{{ next_lang }}">
                  <input type="hidden" name="next" value="{{ request.full_path if request.query_string else request.path }}">
                  <button type="submit"
                          class="no-hover inline-flex items-center justify-center w-10 h-10 hover:text-violet-300 transition text-sm font-bold uppercase tracking-wide">
                    {{ 'EN' if lang == 'ku' else 'کو' }}
                  </button>
                </form>

                <!-- Separator -->
                <div class="h-7 w-px bg-slate-400/30"></div>

                <!-- Theme Toggle -->
                <button type="button" id="themeToggle" data-theme-toggle
                        class="no-hover inline-flex items-center justify-center w-10 h-10 hover:text-violet-300 transition">
                  <svg id="themeIconMoon" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8z"/>
                  </svg>
                  <svg id="themeIconSun" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="4"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.95-1.41-1.41M7.46 7.46 6.05 6.05m12.9 0-1.41 1.41M7.46 16.54l-1.41 1.41"/>
                  </svg>
                </button>

                <!-- User Menu Dropdown -->
                <div class="relative ml-2">
                  <button id="menuButton"
                          class="inline-flex items-center justify-center w-11 h-11 rounded-xl bg-white/10 hover:bg-white/15 transition"
                          aria-expanded="false" aria-controls="menuPanel">
                    <span class="sr-only">{{ t('menu.open') }}</span>
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M20 21a8 8 0 0 0-16 0"/>
                      <circle cx="12" cy="8" r="4"/>
                    </svg>
                  </button>

                  <div id="menuPanel" class="menu-panel absolute right-0 top-full mt-2 w-48 card rounded-2xl p-2 z-50">
                    <div class="flex flex-col gap-1">
                      <a href="{{ url_for('profile') }}"
                         class="w-full px-3 py-2.5 rounded-xl hover:bg-white/10 transition text-sm font-medium inline-flex items-center gap-2.5">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 0 0-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 0 0-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                          <circle cx="12" cy="12" r="3"/>
                        </svg>
                        {{ t('menu.settings') }}
                      </a>
                      <form method="post" action="{{ url_for('logout') }}">
                        <button class="w-full px-3 py-2.5 rounded-xl hover:bg-rose-500/20 transition text-sm font-medium text-rose-400 inline-flex items-center gap-2.5">
                          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 17l5-5-5-5"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H3"/>
                          </svg>
                          {{ t('menu.logout') }}
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {% if current_user.is_authenticated and not is_auth_page and has_household %}
          {% set link_base = "px-4 py-2.5 rounded-xl transition inline-flex items-center gap-2 hover:bg-white/10" %}
          <nav id="topNav" class="w-full flex flex-nowrap overflow-x-auto no-scrollbar items-center gap-2 text-base whitespace-nowrap justify-start sm:justify-center px-2 sm:px-1 sm:col-start-2 sm:row-start-1">
              <a class="{{ link_base }} {{ 'active' if ep=='dashboard' else '' }}" href="{{ url_for('dashboard') }}">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7" rx="1"/>
                  <rect x="14" y="3" width="7" height="7" rx="1"/>
                  <rect x="14" y="14" width="7" height="7" rx="1"/>
                  <rect x="3" y="14" width="7" height="7" rx="1"/>
                </svg>
                {{ t('nav.dashboard') }}
              </a>
              <a class="{{ link_base }} {{ 'active' if ep=='expenses' else '' }}" href="{{ url_for('expenses') }}">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                {{ t('nav.expenses') }}
              </a>
              <a class="{{ link_base }} {{ 'active' if ep=='household' else '' }}" href="{{ url_for('household') }}">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 3h8a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
                  <circle cx="14" cy="12" r="0.8" fill="currentColor"/>
                </svg>
                {{ t('nav.household') }}
              </a>
              <a class="{{ link_base }} {{ 'active' if ep=='archive' else '' }}" href="{{ url_for('archive') }}">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 8v13H3V8"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M1 3h22v5H1z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 12h4"/>
                </svg>
                {{ t('nav.archive') }}
              </a>
          </nav>
        {% endif %}
      </div>
    </header>
    {% if not is_auth_page %}
      <div id="appHeaderSpacer" aria-hidden="true" style="height: 0;"></div>
    {% endif %}
    {% endif %}

    <!-- Mobile Bottom Navigation -->
    {% if current_user.is_authenticated and not is_auth_page and has_household %}
    <div class="mobile-bottom-nav">
      <nav>
        <a href="{{ url_for('dashboard') }}" class="mobile-nav-item {{ 'active' if ep=='dashboard' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="14" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
          </svg>
          <span>{{ t('nav.dashboard') }}</span>
        </a>
        <a href="{{ url_for('expenses') }}" class="mobile-nav-item {{ 'active' if ep=='expenses' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          <span>{{ t('nav.expenses') }}</span>
        </a>
        <a href="{{ url_for('household') }}" class="mobile-nav-item {{ 'active' if ep=='household' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 3h8a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
            <circle cx="14" cy="12" r="0.8" fill="currentColor"/>
          </svg>
          <span>{{ t('nav.household') }}</span>
        </a>
        <a href="{{ url_for('archive') }}" class="mobile-nav-item {{ 'active' if ep=='archive' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8v13H3V8"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M1 3h22v5H1z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 12h4"/>
          </svg>
          <span>{{ t('nav.archive') }}</span>
        </a>
        <a href="{{ url_for('profile') }}" class="mobile-nav-item {{ 'active' if ep=='profile' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <span>{{ t('menu.settings') }}</span>
        </a>
      </nav>
    </div>
    {% endif %}

    <div id="menuBackdrop" class="menu-backdrop fixed inset-0 bg-black/40 z-40"></div>

    <div id="flashMessages">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="{% if not is_auth_page %}mt-5{% endif %} space-y-2 text-center">
          {% for category, message in messages %}
            {% set bg = "bg-emerald-500/15 ring-emerald-400/20" if category=="success" else
                        "bg-rose-500/15 ring-rose-400/20" if category=="error" else
                        "bg-sky-500/15 ring-sky-400/20" %}
            {% if not is_auth_page or category != "error" %}
            <div class="px-4 py-3 rounded-2xl ring-1 {{ bg }}" data-flash-category="{{ category }}" data-flash-message="{{ message }}">
              <div class="text-sm">{{ message }}</div>
            </div>
            {% else %}
            <div class="hidden px-4 py-3 rounded-2xl ring-1 {{ bg }}" data-flash-category="{{ category }}" data-flash-message="{{ message }}">
              <div class="text-sm">{{ message }}</div>
            </div>
            {% endif %}
          {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>

    <main id="appMain" class="{% if not hide_navbar %}mt-6{% endif %} flex flex-col items-center">
      <div class="w-full">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <!-- Mobile FAB for adding expense (only shown on expenses page) -->
  {% if current_user.is_authenticated and not is_auth_page and has_household %}
  <button id="openExpenseFormMobile" style="position: fixed !important; bottom: 90px !important; right: 1rem !important; z-index: 60 !important; width: 56px !important; height: 56px !important; border-radius: 50% !important; background: linear-gradient(135deg, #8B5CF6, #a855f7) !important; box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4), 0 2px 8px rgba(0,0,0,0.3) !important; display: {{ 'flex' if ep == 'expenses' else 'none' }} !important; align-items: center !important; justify-content: center !important; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; border: none !important; cursor: pointer !important; padding: 0 !important; margin: 0 !important;">
    <svg style="width: 1.5rem; height: 1.5rem; color: white;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5"/>
    </svg>
  </button>
  <style>
    @media (min-width: 641px) {
      #openExpenseFormMobile {
        display: none !important;
      }
    }
  </style>
  {% endif %}

  <!-- Custom Confirmation Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 z-[100] items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);">
    <div class="card rounded-3xl p-6 max-w-sm w-full text-center transform transition-all duration-200 relative" id="confirmModalContent" style="opacity: 0; transform: scale(0.95);">
      <button id="confirmModalClose" class="absolute top-4 right-4 p-2 rounded-xl bg-white/10 hover:bg-white/15 transition-colors">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <div class="text-2xl mb-4">⚠️</div>
      <h3 class="text-xl font-bold mb-3" id="confirmModalMessage"></h3>
      <div class="flex gap-3 mt-6">
        <button id="confirmModalCancel" class="flex-1 py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition font-semibold">
          {{ t('common.cancel') }}
        </button>
        <button id="confirmModalConfirm" class="flex-1 py-3 rounded-2xl bg-rose-600 hover:bg-rose-500 transition font-semibold text-white">
          {{ t('common.confirm') }}
        </button>
      </div>
    </div>
  </div>

  <!-- First Visit Welcome Modal -->
  <div id="welcomeModal" class="hidden fixed inset-0 z-[110] items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(6px);">
    <div class="card rounded-3xl p-8 max-w-sm w-full text-center transform transition-all duration-300" id="welcomeModalContent" style="opacity: 0; transform: scale(0.95);">
      <!-- Theme Selection -->
      <div class="mb-8">
        <div class="flex justify-center gap-4">
          <button type="button" id="welcomeThemeDark" class="welcome-theme-btn no-hover w-20 h-20 rounded-2xl bg-[#0A0A0F] border-2 border-white/20 flex items-center justify-center transition-all">
            <svg class="w-10 h-10 text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8z"/>
            </svg>
          </button>
          <button type="button" id="welcomeThemeLight" class="welcome-theme-btn no-hover w-20 h-20 rounded-2xl bg-[#e2e8f0] border-2 border-slate-300 flex items-center justify-center transition-all">
            <svg class="w-10 h-10 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="4"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.95-1.41-1.41M7.46 7.46 6.05 6.05m12.9 0-1.41 1.41M7.46 16.54l-1.41 1.41"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Language Selection -->
      <div class="flex justify-center gap-3 mb-8">
        <button type="button" id="welcomeLangKu" class="welcome-lang-btn no-hover flex-1 py-4 rounded-2xl bg-white/10 border-2 border-white/10 transition-all font-bold text-xl">
          کوردی
        </button>
        <button type="button" id="welcomeLangEn" class="welcome-lang-btn no-hover flex-1 py-4 rounded-2xl bg-white/10 border-2 border-white/10 transition-all font-bold text-xl">
          English
        </button>
      </div>

      <!-- Continue Button -->
      <button type="button" id="welcomeContinueBtn" class="w-full py-4 rounded-2xl bg-violet-500 hover:bg-violet-400 transition font-bold text-lg"
              data-en="{{ t('common.continue', lang='en') }}" data-ku="{{ t('common.continue', lang='ku') }}">
        {{ t('common.continue') }}
      </button>

      <p id="welcomeNote" class="mt-4 text-xs text-slate-400"
         data-en="You can change these later in settings"
         data-ku="دەتوانیت دواتر لە ڕێکخستنەکان بیگۆڕیت">
        You can change these later in settings<br>
        دەتوانیت دواتر لە ڕێکخستنەکان بیگۆڕیت
      </p>
    </div>
  </div>

  <style>
    .welcome-theme-btn:not(.selected):hover,
    .welcome-lang-btn:not(.selected):hover {
      transform: scale(1.05);
      border-color: #a78bfa !important;
    }
    .welcome-theme-btn.selected,
    .welcome-lang-btn.selected {
      box-shadow: 0 0 0 2px #8b5cf6;
      border-color: #8b5cf6 !important;
    }
  </style>

  <script>
    // First Visit Welcome Modal
    (function() {
      const welcomeModal = document.getElementById('welcomeModal');
      const welcomeContent = document.getElementById('welcomeModalContent');
      const themeDarkBtn = document.getElementById('welcomeThemeDark');
      const themeLightBtn = document.getElementById('welcomeThemeLight');
      const langKuBtn = document.getElementById('welcomeLangKu');
      const langEnBtn = document.getElementById('welcomeLangEn');
      const continueBtn = document.getElementById('welcomeContinueBtn');

      if (!welcomeModal) return;

      // Check if first visit
      const hasVisited = localStorage.getItem('hasVisited');
      if (hasVisited) return;

      // Show modal
      welcomeModal.classList.remove('hidden');
      welcomeModal.classList.add('flex');
      document.body.style.overflow = 'hidden';

      requestAnimationFrame(() => {
        welcomeContent.style.opacity = '1';
        welcomeContent.style.transform = 'scale(1)';
      });

      let selectedTheme = 'dark';
      let selectedLang = 'en';

      function selectTheme(theme) {
        selectedTheme = theme;
        const root = document.documentElement;
        root.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);

        // Update button styles
        themeDarkBtn.classList.toggle('selected', theme === 'dark');
        themeLightBtn.classList.toggle('selected', theme === 'light');

        // Sync theme color meta
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        if (themeMeta) {
          themeMeta.setAttribute('content', theme === 'light' ? '#e2e8f0' : '#0A0A0F');
        }
      }

      function selectLang(lang) {
        selectedLang = lang;

        // Update button styles
        langKuBtn.classList.toggle('selected', lang === 'ku');
        langEnBtn.classList.toggle('selected', lang === 'en');

        // Update text content based on language
        const noteEl = document.getElementById('welcomeNote');
        if (continueBtn) continueBtn.textContent = continueBtn.dataset[lang];
        // Keep both languages visible
        if (noteEl) noteEl.innerHTML = noteEl.dataset.en + '<br>' + noteEl.dataset.ku;

        // Save language preference to localStorage and cookie
        localStorage.setItem('lang', lang);
        document.cookie = `lang=${lang};path=/;max-age=31536000;SameSite=Lax`;
      }

      function closeWelcomeModal(shouldReload) {
        welcomeContent.style.opacity = '0';
        welcomeContent.style.transform = 'scale(0.95)';
        setTimeout(() => {
          welcomeModal.classList.add('hidden');
          welcomeModal.classList.remove('flex');
          document.body.style.overflow = '';

          // Reload page to apply the new language
          if (shouldReload) {
            window.location.reload();
          }
        }, 200);
      }

      themeDarkBtn.addEventListener('click', () => selectTheme('dark'));
      themeLightBtn.addEventListener('click', () => selectTheme('light'));
      langKuBtn.addEventListener('click', () => selectLang('ku'));
      langEnBtn.addEventListener('click', () => selectLang('en'));

      // Continue button - save, close, and reload to apply language
      continueBtn.addEventListener('click', () => {
        localStorage.setItem('hasVisited', 'true');
        // Check if selected language differs from current page language
        const currentPageLang = '{{ lang }}';
        const needsReload = selectedLang !== currentPageLang;
        closeWelcomeModal(needsReload);
      });

      // Select defaults
      selectTheme('dark');
      selectLang('en');
    })();
  </script>

  <script>
    (function() {
      const modal = document.getElementById('confirmModal');
      const content = document.getElementById('confirmModalContent');
      const message = document.getElementById('confirmModalMessage');
      const cancelBtn = document.getElementById('confirmModalCancel');
      const confirmBtn = document.getElementById('confirmModalConfirm');
      let resolveCallback = null;

      function showConfirmModal(msg) {
        return new Promise((resolve) => {
          resolveCallback = resolve;
          message.textContent = msg || "{{ t('common.confirm_action') }}";
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          document.body.style.overflow = 'hidden';
          requestAnimationFrame(() => {
            content.style.opacity = '1';
            content.style.transform = 'scale(1)';
          });
        });
      }

      function hideConfirmModal(result) {
        content.style.opacity = '0';
        content.style.transform = 'scale(0.95)';
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = '';
          if (resolveCallback) {
            resolveCallback(result);
            resolveCallback = null;
          }
        }, 200);
      }

      const closeBtn = document.getElementById('confirmModalClose');

      cancelBtn.addEventListener('click', () => hideConfirmModal(false));
      confirmBtn.addEventListener('click', () => hideConfirmModal(true));
      if (closeBtn) closeBtn.addEventListener('click', () => hideConfirmModal(false));
      modal.addEventListener('click', (e) => {
        if (e.target === modal) hideConfirmModal(false);
      });

      window.confirmAction = showConfirmModal;
    })();

    function confirmAction(msg) {
      return window.confirmAction(msg);
    }

    (function () {
      function syncHeaderDock() {
        const header = document.getElementById('appHeader');
        const spacer = document.getElementById('appHeaderSpacer');
        if (!header) return;

        // Keep the spacer height in sync so fixed headers don't overlap page content.
        try {
          const isDesktop = window.matchMedia('(min-width: 641px)').matches;
          const isFixed = header.classList.contains('app-header-fixed');
          
          // Dock styling when scrolling down (more reliable than rect.top for fixed headers).
          if (header.classList.contains('header-shell')) {
            const shouldDock = (window.scrollY || 0) > 2;
            const wasDocked = header.classList.contains('docked');
            header.classList.toggle('docked', shouldDock);
            
            // Update spacer immediately to match the new state
            if (spacer && isDesktop && isFixed) {
              // Always use the base header height - the navbar position handles visual offset
              const targetHeight = header.offsetHeight + 'px';
              if (spacer.style.height !== targetHeight) {
                spacer.style.height = targetHeight;
              }
            } else if (spacer) {
              spacer.style.height = '0px';
            }
          }
        } catch (_) {
          // ignore
        }
      }

      syncHeaderDock();
      window.addEventListener('scroll', () => {
        window.requestAnimationFrame(syncHeaderDock);
      }, { passive: true });

      window.addEventListener('resize', () => {
        window.requestAnimationFrame(syncHeaderDock);
      }, { passive: true });

      const root = document.documentElement;

      function currentTheme() {
        return root.getAttribute('data-theme') || 'dark';
      }

      function syncThemeColor() {
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        if (!themeMeta) return;
        const theme = currentTheme();
        themeMeta.setAttribute('content', theme === 'light' ? '#e2e8f0' : '#0A0A0F');
      }

      function syncThemeToggle() {
        const toggle = document.getElementById('themeToggle');
        const iconSun = document.getElementById('themeIconSun');
        const iconMoon = document.getElementById('themeIconMoon');
        if (!toggle) return;
        const active = currentTheme();
        toggle.setAttribute('aria-pressed', active === 'dark' ? 'true' : 'false');
        if (active === 'dark') {
          if (iconSun) iconSun.classList.remove('hidden');
          if (iconMoon) iconMoon.classList.add('hidden');
        } else {
          if (iconSun) iconSun.classList.add('hidden');
          if (iconMoon) iconMoon.classList.remove('hidden');
        }
      }

      function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        syncThemeColor();
        syncThemeToggle();
      }

      function getMenuEls() {
        return {
          button: document.getElementById('menuButton'),
          panel: document.getElementById('menuPanel'),
          backdrop: document.getElementById('menuBackdrop'),
        };
      }

      function openMenu() {
        const { button, panel, backdrop } = getMenuEls();
        if (!button || !panel) return;
        panel.classList.add('open');
        if (backdrop) backdrop.classList.add('open');
        button.setAttribute('aria-expanded', 'true');
      }

      function closeMenu() {
        const { button, panel, backdrop } = getMenuEls();
        if (!button || !panel) return;
        panel.classList.remove('open');
        if (backdrop) backdrop.classList.remove('open');
        button.setAttribute('aria-expanded', 'false');
      }

      function toggleMenu() {
        const { panel } = getMenuEls();
        if (!panel) return;
        if (panel.classList.contains('open')) closeMenu();
        else openMenu();
      }

      document.addEventListener('click', (e) => {
        const themeBtn = e.target.closest ? e.target.closest('[data-theme-toggle]') : null;
        if (themeBtn) {
          const next = currentTheme() === 'dark' ? 'light' : 'dark';
          setTheme(next);
          return;
        }

        // Language toggle - set cookie and reload page
        const langBtn = e.target.closest ? e.target.closest('#langToggleBtn') : null;
        if (langBtn) {
          const nextLang = langBtn.dataset.next;
          localStorage.setItem('lang', nextLang);
          document.cookie = `lang=${nextLang};path=/;max-age=31536000;SameSite=Lax`;
          // Reload page to apply new language
          window.location.reload();
          return;
        }

        const menuBtn = e.target.closest ? e.target.closest('#menuButton') : null;
        if (menuBtn) {
          toggleMenu();
          return;
        }

        const { panel } = getMenuEls();
        if (panel && panel.classList.contains('open')) {
          const inside = e.target.closest ? e.target.closest('#menuPanel') : null;
          if (!inside) closeMenu();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu();
      });

      window.syncMenuUI = function () {
        syncThemeToggle();
        syncThemeColor();
        closeMenu();
        syncHeaderDock();
      };

      if (!root.getAttribute('data-theme')) {
        root.setAttribute('data-theme', 'dark');
      }
      syncThemeColor();
      syncThemeToggle();
    })();

    // Password toggle function
    window.togglePassword = function(inputId, button) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      
      const eyeOpen = button.querySelectorAll('.eye-open');
      const eyeClosed = button.querySelectorAll('.eye-closed');
      
      eyeOpen.forEach(el => el.classList.toggle('hidden', isPassword));
      eyeClosed.forEach(el => el.classList.toggle('hidden', !isPassword));
    };

    // -----------------------------
    // SPA-like navigation for the top tabs (Dashboard / Expenses / etc.)
    // Prevents full-page refreshes when switching between tabs.
    // -----------------------------
    (function () {
      const nav = document.getElementById('topNav');
      const root = document.getElementById('appRoot');
      if (!nav || !root || !window.fetch || !window.history || !window.DOMParser) return;

      const loadedScriptSrc = new Set();

      function sameOrigin(url) {
        try {
          const u = new URL(url, window.location.href);
          return u.origin === window.location.origin;
        } catch (_) {
          return false;
        }
      }

      function isModifiedClick(e) {
        return e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0;
      }

      async function loadExternalScript(src) {
        if (!src) return;
        if (loadedScriptSrc.has(src)) return;
        loadedScriptSrc.add(src);

        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.async = false;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      }

      async function runScriptsInOrder(scripts) {
        for (const s of scripts) {
          const src = s.getAttribute('src');
          if (src) {
            await loadExternalScript(new URL(src, window.location.href).toString());
          } else {
            const inline = document.createElement('script');
            // Preserve type if present
            const t = s.getAttribute('type');
            if (t) inline.type = t;
            inline.textContent = s.textContent || '';
            document.body.appendChild(inline);
            // Remove immediately to avoid DOM bloat; it already executed.
            inline.remove();
          }
        }
      }

      function extractAndRemoveScripts(container) {
        if (!container) return [];
        const scripts = Array.from(container.querySelectorAll('script'));
        for (const s of scripts) s.remove();
        return scripts;
      }

      function swapFromDoc(doc, { swapHeader = true } = {}) {
        const newHeader = doc.getElementById('appHeader');
        const newFlash = doc.getElementById('flashMessages');
        const newMain = doc.getElementById('appMain');

        const curHeader = document.getElementById('appHeader');
        const curFlash = document.getElementById('flashMessages');
        const curMain = document.getElementById('appMain');

        if (swapHeader && newHeader && curHeader) curHeader.replaceWith(newHeader);
        if (newFlash && curFlash) curFlash.replaceWith(newFlash);
        if (newMain && curMain) curMain.replaceWith(newMain);
        if (window.syncMenuUI) window.syncMenuUI();
        if (window.applyPasswordFieldPolicy) window.applyPasswordFieldPolicy();
      }

      const TAB_PATHS = new Set(['/dashboard', '/expenses', '/room', '/archive', '/profile']);
      const tabCache = new Map();

      function isTabUrl(u) {
        try {
          const url = new URL(u, window.location.href);
          return TAB_PATHS.has(url.pathname) && !url.search;
        } catch {
          return false;
        }
      }

      function makeCacheKey(url) {
        const u = new URL(url, window.location.href);
        return u.origin + u.pathname; // no query for tabs
      }

      function cacheFromHtml(url, html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const title = doc.querySelector('title')?.textContent || '';
        const newMain = doc.getElementById('appMain');
        if (!newMain) return;
        const scripts = extractAndRemoveScripts(newMain);
        const scriptSpecs = scripts.map(s => ({
          src: s.getAttribute('src'),
          type: s.getAttribute('type'),
          text: s.textContent || ''
        }));

        tabCache.set(makeCacheKey(url), {
          title,
          mainOuterHTML: newMain.outerHTML,
          flashOuterHTML: doc.getElementById('flashMessages')?.outerHTML || null,
          scriptSpecs
        });
      }

      async function runScriptSpecsInOrder(specs) {
        if (!specs || !specs.length) return;
        for (const spec of specs) {
          if (spec.src) {
            await loadExternalScript(new URL(spec.src, window.location.href).toString());
            continue;
          }
          const inline = document.createElement('script');
          if (spec.type) inline.type = spec.type;
          inline.textContent = spec.text;
          document.body.appendChild(inline);
          inline.remove();
        }
      }

      function applyTabCache(url) {
        const key = makeCacheKey(url);
        const cached = tabCache.get(key);
        if (!cached) return false;

        if (cached.title) document.title = cached.title;

        const curMain = document.getElementById('appMain');
        if (curMain) {
          const wrapper = document.createElement('div');
          wrapper.innerHTML = cached.mainOuterHTML;
          const nextMain = wrapper.firstElementChild;
          if (nextMain) curMain.replaceWith(nextMain);
        }

        if (cached.flashOuterHTML) {
          const curFlash = document.getElementById('flashMessages');
          if (curFlash) {
            const fw = document.createElement('div');
            fw.innerHTML = cached.flashOuterHTML;
            const nextFlash = fw.firstElementChild;
            if (nextFlash) curFlash.replaceWith(nextFlash);
          }
        }

        if (window.syncMenuUI) window.syncMenuUI();
        if (window.applyPasswordFieldPolicy) window.applyPasswordFieldPolicy();
        // Run scripts for the cached page.
        runScriptSpecsInOrder(cached.scriptSpecs);
        return true;
      }

      async function navigate(url, { push = true } = {}) {
        const target = new URL(url, window.location.href);

        // If only the hash changes, let the browser handle it.
        if (target.pathname === window.location.pathname && target.search === window.location.search) {
          if (push) window.history.pushState({}, '', target.href);
          if (target.hash) {
            const el = document.getElementById(target.hash.slice(1));
            if (el) el.scrollIntoView({ behavior: 'smooth' });
          }
          return;
        }

        const isTab = TAB_PATHS.has(target.pathname) && !target.search;

        // Update active nav state immediately for instant visual feedback
        updateActiveNav(target.href);
        if (push) window.history.pushState({}, '', target.href);

        // Instant tab switching from in-memory cache (no network)
        if (isTab && applyTabCache(target.href)) {
          window.scrollTo({ top: 0, behavior: 'instant' });
          return;
        }

        let res;
        try {
          res = await fetch(target.href, {
            method: 'GET',
            headers: { 'X-Requested-With': 'fetch' },
            credentials: 'same-origin'
          });
        } catch (_) {
          window.location.href = target.href;
          return;
        }

        // If server redirects (e.g. not logged in), fall back to normal navigation.
        if (!res.ok || res.redirected) {
          window.location.href = res.url || target.href;
          return;
        }

        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');

        // Update title
        const title = doc.querySelector('title');
        if (title && title.textContent) document.title = title.textContent;

        // Extract scripts from new main BEFORE swapping (scripts inserted via innerHTML won't run).
        const newMain = doc.getElementById('appMain');
        const scripts = extractAndRemoveScripts(newMain);

        // Cache tab pages after fetching (for instant next switch)
        if (isTab) {
          try { cacheFromHtml(target.href, html); } catch (_) {}
        }

        // Swap flash/main (keep header stable for tabs)
        swapFromDoc(doc, { swapHeader: !isTab });

        // Scroll to top instantly (no smooth scroll for faster feel)
        window.scrollTo({ top: 0, behavior: 'instant' });

        // Run any scripts that were part of the new page.
        await runScriptsInOrder(scripts);
      }

      // Expose navigate globally for use in page scripts
      window.navigate = navigate;

      // Password fields: do not show placeholder text anywhere.
      window.applyPasswordFieldPolicy = function () {
        document.querySelectorAll('input[type="password"]').forEach((input) => {
          if (input.hasAttribute('placeholder')) input.removeAttribute('placeholder');
        });
      };

      function updateActiveNav(url) {
        // Remove active class from all nav items
        const allNavItems = document.querySelectorAll('#topNav a, #menuPanel a, .mobile-bottom-nav a');
        allNavItems.forEach(item => item.classList.remove('active'));

        // Determine which endpoint this URL corresponds to
        const path = new URL(url, window.location.origin).pathname;
        let endpoint = '';

        if (path === '/' || path.startsWith('/dashboard')) endpoint = 'dashboard';
        else if (path.startsWith('/expenses')) endpoint = 'expenses';
        else if (path.startsWith('/room') || path.startsWith('/household')) endpoint = 'room';
        else if (path.startsWith('/archive')) endpoint = 'archive';
        else if (path.startsWith('/profile')) endpoint = 'profile';

        // Add active class to matching nav items
        if (endpoint) {
          const selector = `#topNav a[href*="${endpoint}"], #menuPanel a[href*="${endpoint}"], .mobile-bottom-nav a[href*="${endpoint}"]`;
          const activeItems = document.querySelectorAll(selector);
          activeItems.forEach(item => {
            const href = item.getAttribute('href');
            if (href && (href === `/${endpoint}` || href.startsWith(`/${endpoint}?`) || href.startsWith(`/${endpoint}/`))) {
              item.classList.add('active');
            }
          });
        }

        // Show/hide FAB button based on endpoint
        const fab = document.getElementById('openExpenseFormMobile');
        if (fab) {
          if (endpoint === 'expenses') {
            fab.style.display = 'flex';
          } else {
            fab.style.display = 'none';
          }
        }
      }

      document.addEventListener('click', (e) => {
        const a = e.target && e.target.closest ? e.target.closest('a[href]') : null;
        if (!a) return;
        if (a.target && a.target !== '_self') return;
        if (isModifiedClick(e)) return;
        if (a.hasAttribute('download')) return;
        if (a.hasAttribute('data-no-spa')) return;
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:')) return;
        if (!sameOrigin(href)) return;

        // Only SPA-navigate for the main tabs to keep things reliable.
        const targetUrl = new URL(href, window.location.href);
        if (!TAB_PATHS.has(targetUrl.pathname) || targetUrl.search) return;

        e.preventDefault();
        navigate(targetUrl.href, { push: true });
      });

      window.addEventListener('popstate', () => {
        const u = new URL(window.location.href);
        if (TAB_PATHS.has(u.pathname) && !u.search) {
          navigate(u.href, { push: false });
        } else {
          window.location.href = u.href;
        }
      });

      // Initialize FAB visibility on page load
      updateActiveNav(window.location.href);
      if (window.applyPasswordFieldPolicy) window.applyPasswordFieldPolicy();

      // Seed cache with the current page if it's a tab
      if (isTabUrl(window.location.href)) {
        try { cacheFromHtml(window.location.href, document.documentElement.outerHTML); } catch (_) {}
      }

      // Prefetch other tabs after load so switching feels instant.
      const prefetchTabs = () => {
        const origin = window.location.origin;
        for (const path of TAB_PATHS) {
          const full = origin + path;
          const key = makeCacheKey(full);
          if (tabCache.has(key)) continue;
          fetch(full, { method: 'GET', headers: { 'X-Requested-With': 'prefetch' }, credentials: 'same-origin' })
            .then(r => (r.ok && !r.redirected) ? r.text() : null)
            .then(t => { if (t) cacheFromHtml(full, t); })
            .catch(() => {});
        }
      };
      if ('requestIdleCallback' in window) {
        window.requestIdleCallback(prefetchTabs, { timeout: 1500 });
      } else {
        setTimeout(prefetchTabs, 600);
      }

    })();

    // Global AJAX form handler for SPA-like experience
    window.submitFormAjax = async function(form, options = {}) {
      const formData = new FormData(form);
      const method = form.method || 'POST';
      const action = form.action || window.location.href;

      try {
        const response = await fetch(action, {
          method: method,
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });

        const finalUrl = response.url || action;

        // Sometimes `fetch()` ends up on a different URL (after server redirects)
        // but `response.redirected` may not reliably reflect it in all cases.
        // If we clearly landed on a different page, navigate there.
        try {
          const dest = new URL(finalUrl, window.location.origin);
          const here = new URL(window.location.href);
          if (dest.pathname !== here.pathname) {
            if (options.onRedirect) {
              options.onRedirect(finalUrl);
            } else {
              window.location.href = finalUrl;
            }
            return null;
          }
        } catch (_) {
          // ignore
        }

        // If the server responded with a redirect, fetch will typically follow it
        // and give us the final HTML in the response body. Showing those flash messages
        // on the *current* page causes a brief flicker before navigation.
        // Only render flashes from the HTML when we ultimately land back on the same page.
        if (response.redirected) {
          let samePath = false;
          try {
            const dest = new URL(finalUrl, window.location.origin);
            const here = new URL(window.location.href);
            samePath = dest.pathname === here.pathname;
          } catch (_) {
            samePath = false;
          }

          if (samePath) {
            const html = await response.text().catch(() => '');
            let doc = null;
            if (html) {
              const parser = new DOMParser();
              doc = parser.parseFromString(html, 'text/html');

              const flashMessages = doc.getElementById('flashMessages');
              if (flashMessages) {
                const currentFlash = document.getElementById('flashMessages');
                if (currentFlash) currentFlash.innerHTML = flashMessages.innerHTML;
                
                // Check if there are error flash messages - if so, call onError instead of onSuccess
                const errorFlashes = flashMessages.querySelectorAll('[data-flash-category="error"]');
                if (errorFlashes.length > 0) {
                  if (options.onError) options.onError(doc);
                  return doc;
                }
              }
            }
            if (options.onSuccess && doc) options.onSuccess(doc);
            return doc;
          }

          if (options.onRedirect) {
            options.onRedirect(finalUrl);
          } else {
            window.location.href = finalUrl;
          }
          return null;
        }

        if (!response.ok) {
          if (options.onError) options.onError(response);
          return null;
        }

        const html = await response.text();

        // Parse the response to extract flash messages and update content
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Extract and show flash messages
        const flashMessages = doc.getElementById('flashMessages');
        if (flashMessages) {
          const currentFlash = document.getElementById('flashMessages');
          if (currentFlash) {
            currentFlash.innerHTML = flashMessages.innerHTML;
          }
        }

        // If callback provided, let it handle the update
        if (options.onSuccess) {
          options.onSuccess(doc);
        }

        return doc;
      } catch (error) {
        console.error('Form submission error:', error);
        if (options.onError) {
          options.onError(error);
        }
        return null;
      }
    };

    // Show flash message dynamically
    window.showFlash = function(message, category = 'success') {
      const flashContainer = document.getElementById('flashMessages');
      if (!flashContainer) return;

      const bgClass = category === 'success' ? 'bg-emerald-500/15 ring-emerald-400/20' :
                      category === 'error' ? 'bg-rose-500/15 ring-rose-400/20' :
                      'bg-sky-500/15 ring-sky-400/20';

      const flashHTML = `
        <div class="mt-5 space-y-2 text-center">
          <div class="px-4 py-3 rounded-2xl ring-1 ${bgClass}">
            <div class="text-sm">${message}</div>
          </div>
        </div>
      `;

      flashContainer.innerHTML = flashHTML;

      // Auto-hide after 5 seconds
      setTimeout(() => {
        flashContainer.innerHTML = '';
      }, 5000);
    };

    // Prefetch nav pages on hover for faster navigation
    (function() {
      const prefetched = new Set();
      
      document.addEventListener('mouseover', function(e) {
        const link = e.target.closest('a');
        if (!link) return;
        
        const href = link.getAttribute('href');
        if (!href || prefetched.has(href)) return;
        
        // Only prefetch main nav pages
        if (href.match(/^\/(dashboard|expenses|room|archive|profile)$/)) {
          prefetched.add(href);
          const prefetchLink = document.createElement('link');
          prefetchLink.rel = 'prefetch';
          prefetchLink.href = href;
          document.head.appendChild(prefetchLink);
        }
      });
      
      // Prefetch all main pages after load
      setTimeout(function() {
        ['/dashboard', '/expenses', '/room', '/archive', '/profile'].forEach(function(href) {
          if (!prefetched.has(href)) {
            prefetched.add(href);
            const prefetchLink = document.createElement('link');
            prefetchLink.rel = 'prefetch';
            prefetchLink.href = href;
            document.head.appendChild(prefetchLink);
          }
        });
      }, 1000);
    })();
  </script>
</body>
</html>
