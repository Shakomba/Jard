{% extends "base.html" %}
{% block content %}

<div class="flex flex-col items-center text-center gap-2 mb-6">
  <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-violet-400 to-purple-400 bg-clip-text text-transparent">
    {{ t('expenses.title') }}
  </h1>
  {% if filter_user %}
    <div class="flex items-center gap-2 px-4 py-2 rounded-2xl bg-violet-500/20 border border-violet-400/30">
      <span class="text-sm text-slate-200">{{ t('expenses.filtered_by') }} <strong>{{ user_by_id[filter_user|int].name }}</strong></span>
      <a href="{{ url_for('expenses') }}" class="ml-2 px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-xs transition">
        {{ t('expenses.clear_filter') }}
      </a>
    </div>
  {% endif %}
</div>

<!-- Modal for mobile add expense -->
<div id="expenseModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-200">
  <div id="expenseModalBackdrop" class="absolute inset-0 bg-black/70 transition-opacity duration-200"></div>
  <div id="expenseModalContent" class="relative w-full max-w-lg card rounded-3xl p-6 text-start max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-xl font-bold">{{ t('expenses.add_title') }}</h2>
      <button id="closeExpenseModal" class="p-2 rounded-xl bg-white/10 hover:bg-white/15">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <form class="space-y-4" method="post" action="{{ url_for('add_expense') }}">
      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.title_label') }}</label>
        <input name="title" required
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
               placeholder="{{ t('expenses.title_placeholder') }}" />
      </div>

      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.amount_label') }}</label>
        <input name="amount_iqd" type="number" required min="250" step="250"
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
               placeholder="250" dir="ltr" />
      </div>

      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.date_label') }}</label>
        <input name="expense_date" type="date" value="{{ today }}"
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400 ltr" />
      </div>

      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.participants_label') }}</label>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          {% for m in members %}
            <label class="flex items-center justify-between gap-3 px-4 py-3 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer transition-all" dir="ltr">
              <div class="flex items-center gap-3">
                <img src="{{ url_for('avatar', user_id=m.id) }}" alt="{{ m.name }}"
                     class="h-8 w-8 rounded-full object-cover ring-2 ring-white/10 bg-white/5">
                <span class="text-sm font-medium">{{ m.name }}</span>
                {% if m.id == current_user.id %}
                  <span class="inline-flex items-center text-[10px] font-bold px-2 py-1 rounded-md bg-violet-500/30 text-violet-200 leading-none uppercase tracking-wide">{{ t('common.you') }}</span>
                {% endif %}
              </div>
              <input type="checkbox" name="participants" value="{{ m.id }}" checked class="h-5 w-5 rounded text-violet-500 border-white/20 focus:ring-violet-400 focus:ring-2">
            </label>
          {% endfor %}
        </div>
      </div>

      <button type="submit" class="w-full py-4 rounded-2xl bg-gradient-to-r from-violet-500 to-purple-500 hover:from-violet-400 hover:to-purple-400 transition font-bold text-white shadow-lg shadow-violet-500/30">
        {{ t('expenses.add_button') }}
      </button>
    </form>
  </div>
</div>

<div class="flex flex-col gap-6 lg:grid lg:grid-cols-3 lg:items-start">
  <!-- Add expense (desktop only - right column) -->
  <div id="desktopExpenseForm" class="card rounded-3xl p-6 text-center lg:col-start-3 lg:col-span-1 lg:row-start-1">
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-xl font-bold">{{ t('expenses.add_title') }}</h2>
    </div>

    <form class="space-y-4" method="post" action="{{ url_for('add_expense') }}">
      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.title_label') }}</label>
        <input name="title" required
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
               placeholder="{{ t('expenses.title_placeholder') }}" />
      </div>

      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.amount_label') }}</label>
        <input name="amount_iqd" type="number" required min="250" step="250"
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
               placeholder="250" dir="ltr" />
      </div>

      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.date_label') }}</label>
        <input name="expense_date" type="date" value="{{ today }}"
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400 ltr" />
      </div>

      <div class="text-start">
        <label class="text-sm font-medium text-slate-200 block mb-2">{{ t('expenses.participants_label') }}</label>
        <div class="space-y-2 max-h-48 overflow-y-auto">
          {% for m in members %}
            <label class="flex items-center justify-between gap-3 px-4 py-3 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer transition-all" dir="ltr">
              <div class="flex items-center gap-3">
                <img src="{{ url_for('avatar', user_id=m.id) }}" alt="{{ m.name }}"
                     class="h-8 w-8 rounded-full object-cover ring-2 ring-white/10 bg-white/5">
                <span class="text-sm font-medium">{{ m.name }}</span>
                {% if m.id == current_user.id %}
                  <span class="inline-flex items-center text-[10px] font-bold px-2 py-1 rounded-md bg-violet-500/30 text-violet-200 leading-none uppercase tracking-wide">{{ t('common.you') }}</span>
                {% endif %}
              </div>
              <input type="checkbox" name="participants" value="{{ m.id }}" checked class="h-5 w-5 rounded text-violet-500 border-white/20 focus:ring-violet-400 focus:ring-2">
            </label>
          {% endfor %}
        </div>
      </div>

      <button type="submit" class="w-full py-4 rounded-2xl bg-gradient-to-r from-violet-500 to-purple-500 hover:from-violet-400 hover:to-purple-400 transition font-bold text-white shadow-lg shadow-violet-500/30">
        {{ t('expenses.add_button') }}
      </button>
    </form>
  </div>

  <!-- Entries list with improved design -->
  <div class="card rounded-3xl p-6 lg:col-start-1 lg:col-span-2 lg:row-start-1">
    {% if expenses|length == 0 %}
      <div class="soft rounded-3xl p-12 text-center">
        <svg class="w-20 h-20 mx-auto mb-4 text-slate-400/60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        <p class="text-lg font-medium text-slate-200">{{ t('expenses.no_expenses') }}</p>
        <p class="text-sm text-slate-400 mt-2">{{ t('expenses.add_first') }}</p>
      </div>
    {% else %}
      <div class="space-y-4">
        {% for e in expenses %}
          {% set mine = (e.payer_id == current_user.id) %}
          <div class="soft rounded-3xl p-5 {% if mine %}ring-2 ring-inset ring-violet-400/60 bg-gradient-to-br from-violet-500/20 via-purple-500/15 to-transparent shadow-lg shadow-violet-500/20{% endif %}">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div class="min-w-0 text-start flex-1">
                <div class="font-bold text-xl truncate mb-2">
                  {{ e.title }}
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs text-slate-300">
                  <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-black/20">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 2v4M8 2v4M3 10h18"/>
                    </svg>
                    <span class="ltr font-medium">{{ e.expense_date }}</span>
                  </div>
                  <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-black/20">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/>
                    </svg>
                    <span class="ltr font-medium">{{ e.created_at.strftime('%I:%M %p') }}</span>
                  </div>
                  <div class="flex items-center gap-2 px-2 py-1 rounded-lg bg-black/20">
                    <img src="{{ url_for('avatar', user_id=e.payer_id) }}" alt="{{ user_by_id[e.payer_id].name }}"
                         class="h-5 w-5 rounded-full object-cover ring-1 ring-white/10 bg-white/5">
                    <span class="font-medium" dir="ltr">{{ user_by_id[e.payer_id].name }}</span>
                  </div>
                </div>
              </div>

              <div class="shrink-0 flex flex-col items-center sm:items-end gap-3">
                <div class="text-2xl font-black text-slate-100"><span class="ltr">{{ e.amount_iqd|iqd }}</span></div>

                {% if mine %}
                  <form method="post" action="{{ url_for('delete_expense', expense_id=e.id) }}" class="m-0">
                    <button type="submit"
                            data-confirm="{{ t('expenses.delete_confirm') | e }}"
                            class="px-5 py-3 rounded-xl bg-rose-600 hover:bg-rose-500 transition text-sm font-bold text-white shadow-lg shadow-rose-500/30">
                      {{ t('expenses.delete_button') }}
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
            
            <!-- Participants -->
            <div class="mt-4 pt-4 border-t border-white/10">
              {% set pids = parts_map.get(e.id, []) %}
              <div class="flex flex-wrap gap-2">
                {% for pid in pids %}
                  <a href="{{ url_for('expenses', filter_user=pid) }}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 hover:border-violet-400/30 transition-all cursor-pointer text-xs">
                    <img src="{{ url_for('avatar', user_id=pid) }}" alt="{{ user_by_id[pid].name }}"
                         class="h-5 w-5 rounded-full object-cover ring-1 ring-white/10 bg-white/5">
                    <span class="font-medium" dir="ltr">{{ user_by_id[pid].name }}</span>
                  </a>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Mobile expense modal toggle
  (function() {
    const modal = document.getElementById('expenseModal');
    const modalContent = document.getElementById('expenseModalContent');
    const backdrop = document.getElementById('expenseModalBackdrop');
    const closeBtn = document.getElementById('closeExpenseModal');

    if (!modal) return;

    function openModal() {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';

      // Hide the FAB
      const fab = document.getElementById('openExpenseFormMobile');
      if (fab) fab.style.display = 'none';

      // Trigger animation
      requestAnimationFrame(() => {
        modal.classList.remove('opacity-0');
        modal.classList.add('opacity-100');
        if (modalContent) {
          modalContent.classList.remove('scale-95');
          modalContent.classList.add('scale-100');
        }
      });
    }

    function closeModal() {
      modal.classList.remove('opacity-100');
      modal.classList.add('opacity-0');
      if (modalContent) {
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
      }

      // Wait for animation to complete before hiding
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';

        // Show the FAB
        const fab = document.getElementById('openExpenseFormMobile');
        if (fab) fab.style.display = 'flex';
      }, 200);
    }

    // Use event delegation for FAB button (more reliable)
    // Remove any existing delegated listener first
    if (window._fabDelegatedHandler) {
      document.body.removeEventListener('click', window._fabDelegatedHandler);
    }

    // Create and store new delegated handler
    window._fabDelegatedHandler = function(e) {
      const openBtn = e.target.closest('#openExpenseFormMobile');
      if (openBtn) {
        e.preventDefault();
        e.stopPropagation();
        openModal();
      }
    };

    document.body.addEventListener('click', window._fabDelegatedHandler);

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (backdrop) backdrop.addEventListener('click', closeModal);

    // Remove existing escape key listeners and add new one
    const escapeHandler = (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    };
    document.addEventListener('keydown', escapeHandler);

    // Handle delete expense confirmations with AJAX
    document.querySelectorAll('button[data-confirm]').forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const confirmMsg = button.getAttribute('data-confirm');
        const confirmed = await confirmAction(confirmMsg);
        if (confirmed) {
          const form = button.closest('form');
          // Submit via AJAX and reload the current page content
          await submitFormAjax(form, {
            onSuccess: () => {
              // Reload expenses page without full page refresh
              navigate(window.location.href, { push: false });
            }
          });
        }
      });
    });

    // Handle add expense forms with AJAX
    const addExpenseForms = document.querySelectorAll('form[action*="add_expense"]');
    addExpenseForms.forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Disable submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        await submitFormAjax(form, {
          onSuccess: () => {
            // Close modal if it was the mobile form
            if (form.id === 'addExpenseFormMobile' || form.closest('#expenseModal')) {
              const modal = document.getElementById('expenseModal');
              if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
              }
              // Show the FAB
              const fab = document.getElementById('openExpenseFormMobile');
              if (fab) fab.style.display = 'flex';
            }

            // Reset form
            form.reset();

            // Reload expenses page without full page refresh
            navigate(window.location.href, { push: false });
          },
          onError: () => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });

        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
    });
  })();
</script>
{% endblock %}
