{% extends "base.html" %}
{% block content %}
<div class="grid md:grid-cols-2 gap-6 items-start">
  <div class="card rounded-3xl p-8 text-center">
    <h1 class="text-3xl font-bold mb-2">{{ t('setup.create_title') }}</h1>

    <form id="createHouseholdForm" class="mt-6 space-y-4" method="post" action="{{ url_for('create_household') }}">
      <div class="text-start">
        <label class="text-sm text-slate-200">{{ t('setup.household_name_label') }}</label>
        <input name="household_name" type="text"
               class="mt-1 w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
               placeholder="{{ t('setup.household_name_placeholder') }}" />
      </div>
      <button type="submit" class="w-full py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-400 transition font-semibold">
        {{ t('setup.create_button') }}
      </button>
    </form>
  </div>

  <div class="card rounded-3xl p-8 text-center">
    <h1 class="text-3xl font-bold mb-2">{{ t('setup.join_title') }}</h1>

    <form id="joinHouseholdForm" class="mt-6 space-y-4" method="post" action="{{ url_for('join_household') }}">
      <div class="text-start">
        <label class="text-sm text-slate-200">{{ t('setup.join_code_label') }}</label>
        <input id="joinCodeInput" name="join_code" type="text" required
               class="mt-1 w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400 uppercase tracking-widest"
               placeholder="{{ t('setup.join_code_placeholder') }}" dir="ltr" />
        <div id="joinError" class="mt-2 text-sm text-rose-400 hidden"></div>
      </div>
      <button type="submit" class="w-full py-3 rounded-2xl bg-violet-500 hover:bg-violet-400 transition font-semibold">
        {{ t('setup.join_button') }}
      </button>
    </form>

    <div class="mt-6">
      <div class="relative flex items-center justify-center">
        <div class="absolute inset-x-0 h-px bg-white/10"></div>
        <div class="relative px-4 text-xs uppercase tracking-widest text-slate-400 bg-[--bg]">{{ t('common.or') }}</div>
      </div>
    </div>

    <!-- Join by QR (live camera or gallery) - REDESIGNED FOR VISIBILITY -->
    <div class="mt-6 card rounded-3xl p-6 border-2 border-violet-500/30 bg-gradient-to-br from-violet-500/10 to-transparent">
      <div class="flex items-center justify-center gap-3 mb-4">
        <div class="p-3 rounded-2xl bg-violet-500/20">
          <svg class="w-8 h-8 text-violet-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 17h.01M17 7h.01"/>
          </svg>
        </div>
        <div class="text-start">
          <div class="text-xl font-bold text-violet-200">{{ t('setup.qr_title') }}</div>
          <div class="text-sm text-slate-300">
            {{ t('setup.qr_description') }}
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <button type="button" id="openQrModal"
                class="flex-1 px-6 py-4 rounded-2xl bg-gradient-to-r from-violet-500 to-purple-500 hover:from-violet-400 hover:to-purple-400 transition text-base font-bold text-white shadow-lg shadow-violet-500/30">
          <svg class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
            <circle cx="12" cy="13" r="3"/>
          </svg>
          {{ t('setup.qr_scan_button') }}
        </button>

        <label for="qrGalleryInput"
               class="flex-1 px-6 py-4 rounded-2xl bg-white/10 hover:bg-white/15 transition text-base font-bold text-center cursor-pointer flex items-center justify-center">
          <svg class="w-5 h-5 inline-block mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 15l-5-5L5 21"/>
          </svg>
          {{ t('setup.qr_select_button') }}
        </label>
      </div>

      <input id="qrGalleryInput" type="file" accept="image/*" class="sr-only" />

      <div id="qrStatus" class="mt-4 text-sm text-slate-300 text-center"></div>

      <!-- hidden canvas for decoding -->
      <canvas id="qrCanvas" class="hidden"></canvas>
    </div>
  </div>
</div>

<div id="qrModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
  <div id="qrModalBackdrop" class="absolute inset-0 bg-black/70"></div>

  <div class="relative w-full max-w-lg card rounded-3xl p-5 text-start">
    <div class="flex items-start justify-between gap-3 mb-4">
      <div>
        <div class="text-sm text-slate-300">{{ t('setup.qr_modal_title') }}</div>
        <h2 class="mt-1 text-xl font-semibold">{{ t('setup.qr_modal_subtitle') }}</h2>
        <div class="mt-1 text-xs text-slate-300">
          {{ t('setup.qr_modal_help') }}
        </div>
      </div>
      <button type="button" id="closeQrModal"
              class="p-2 rounded-xl bg-white/10 hover:bg-white/15 transition-colors">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div id="qrScannerView" class="mt-4">
      <div class="relative overflow-hidden rounded-2xl bg-black/40">
        <video id="qrVideo" class="w-full h-64 sm:h-72 object-cover" playsinline muted></video>
        <canvas id="qrOverlay" class="absolute inset-0 w-full h-full"></canvas>
      </div>
      <div id="qrLiveStatus" class="mt-3 text-xs text-slate-300"></div>
    </div>

    <div id="qrResultView" class="mt-4 hidden">
      <div class="text-sm text-slate-300">{{ t('setup.qr_detected') }}</div>
      <div id="qrResultCode"
           class="mt-2 rounded-2xl bg-black/30 border border-white/10 px-4 py-3 text-center font-mono tracking-widest ltr"></div>
      <div id="qrJoinError" class="mt-2 text-sm text-rose-400 hidden"></div>
      <form id="qrJoinForm" class="mt-4 space-y-3" method="post" action="{{ url_for('join_household') }}">
        <input id="qrJoinCodeInput" name="join_code" type="hidden" />
        <button type="submit" class="w-full py-3 rounded-2xl bg-violet-500 hover:bg-violet-400 transition text-sm font-semibold">
          {{ t('setup.qr_join_button') }}
        </button>
        <button type="button" id="qrRescan"
                class="w-full py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition text-sm font-semibold">
          {{ t('setup.qr_scan_again') }}
        </button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  (function () {
    const openBtn = document.getElementById('openQrModal');
    const modal = document.getElementById('qrModal');
    const backdrop = document.getElementById('qrModalBackdrop');
    const closeBtn = document.getElementById('closeQrModal');
    const rescanBtn = document.getElementById('qrRescan');
    const scannerView = document.getElementById('qrScannerView');
    const resultView = document.getElementById('qrResultView');
    const resultCodeEl = document.getElementById('qrResultCode');
    const joinInput = document.getElementById('qrJoinCodeInput');

    const video = document.getElementById('qrVideo');
    const overlay = document.getElementById('qrOverlay');
    const overlayCtx = overlay ? overlay.getContext('2d') : null;
    const canvas = document.getElementById('qrCanvas');
    const ctx = canvas ? canvas.getContext('2d') : null;

    const statusEl = document.getElementById('qrStatus');
    const liveStatusEl = document.getElementById('qrLiveStatus');
    const galIn = document.getElementById('qrGalleryInput');

    let stream = null;
    let rafId = null;
    let lastScanAt = 0;
    let audioCtx = null;
    const qrStrings = {
      cameraNotSupported: "{{ t('setup.qr_status.camera_not_supported') }}",
      scannerUnavailable: "{{ t('setup.qr_status.scanner_unavailable') }}",
      startingCamera: "{{ t('setup.qr_status.starting_camera') }}",
      cameraBlocked: "{{ t('setup.qr_status.camera_blocked') }}",
      cameraFailed: "{{ t('setup.qr_status.camera_failed') }}",
      invalidCode: "{{ t('setup.qr_status.invalid_code') }}",
      reading: "{{ t('setup.qr_status.reading') }}",
      notFound: "{{ t('setup.qr_status.not_found') }}",
      detected: "{{ t('setup.qr_status.detected') }}",
    };

    function setStatus(el, msg, isError) {
      if (!el) return;
      el.textContent = msg || '';
      el.className = 'mt-3 text-xs ' + (isError ? 'text-rose-200' : 'text-slate-300');
    }

    function ensureAudio() {
      if (audioCtx) return;
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;
      audioCtx = new AudioCtx();
    }

    function beep() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = 880;
      gain.gain.value = 0.0001;
      gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.13);
    }

    function vibrate() {
      if (navigator.vibrate) navigator.vibrate(120);
    }

    function extractJoinCode(payload) {
      let v = (payload || '').trim();
      if (!v) return null;
      if (v.startsWith('http://') || v.startsWith('https://')) {
        try {
          const u = new URL(v);
          v = u.pathname || '';
        } catch (_) {
          return null;
        }
      }
      if (v.startsWith('/')) {
        if (v.startsWith('/join/')) {
          return decodeURIComponent(v.slice('/join/'.length));
        }
        return null;
      }
      return v;
    }

    function resetViews() {
      if (scannerView) scannerView.classList.remove('hidden');
      if (resultView) resultView.classList.add('hidden');
      if (resultCodeEl) resultCodeEl.textContent = '';
      if (joinInput) joinInput.value = '';
    }

    function showResult(payload, fromLive) {
      const code = extractJoinCode(payload);
      if (!code) {
        setStatus(fromLive ? liveStatusEl : statusEl, qrStrings.invalidCode, true);
        return false;
      }
      if (resultCodeEl) resultCodeEl.textContent = code.toUpperCase();
      if (joinInput) joinInput.value = code;
      if (scannerView) scannerView.classList.add('hidden');
      if (resultView) resultView.classList.remove('hidden');
      return true;
    }

    function openModal() {
      if (!modal) return;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      if (!modal) return;
      stopScan();
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }

    function syncCanvas() {
      if (!video || !canvas || !overlay) return;
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (!w || !h) return;
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
      if (overlay.width !== w || overlay.height !== h) {
        overlay.width = w;
        overlay.height = h;
      }
    }

    function drawLine(a, b) {
      if (!overlayCtx) return;
      overlayCtx.beginPath();
      overlayCtx.moveTo(a.x, a.y);
      overlayCtx.lineTo(b.x, b.y);
      overlayCtx.lineWidth = 4;
      overlayCtx.strokeStyle = 'rgba(99, 102, 241, 0.9)';
      overlayCtx.stroke();
    }

    function drawBox(loc) {
      if (!overlayCtx || !overlay) return;
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      if (!loc) return;
      drawLine(loc.topLeftCorner, loc.topRightCorner);
      drawLine(loc.topRightCorner, loc.bottomRightCorner);
      drawLine(loc.bottomRightCorner, loc.bottomLeftCorner);
      drawLine(loc.bottomLeftCorner, loc.topLeftCorner);
    }

    async function startScan() {
      if (!video || !ctx) return;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus(liveStatusEl, qrStrings.cameraNotSupported, true);
        return;
      }
      if (!window.jsQR) {
        setStatus(liveStatusEl, qrStrings.scannerUnavailable, true);
        return;
      }
      resetViews();
      lastScanAt = 0;
      setStatus(liveStatusEl, qrStrings.startingCamera);

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } },
          audio: false,
        });
      } catch (err) {
        console.error('Camera error:', err);
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          setStatus(liveStatusEl, qrStrings.cameraBlocked, true);
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
          setStatus(liveStatusEl, 'No camera found on this device.', true);
        } else if (err.name === 'NotSupportedError' || err.name === 'NotReadableError') {
          setStatus(liveStatusEl, 'Camera is in use by another app or not supported.', true);
        } else {
          setStatus(liveStatusEl, qrStrings.cameraFailed + ' ' + (err.message || ''), true);
        }
        return;
      }

      video.srcObject = stream;
      try {
        await video.play();
      } catch (err) {
        console.error('Video play error:', err);
        setStatus(liveStatusEl, qrStrings.cameraFailed, true);
        return;
      }
      syncCanvas();
      rafId = requestAnimationFrame(scanFrame);
    }

    function stopScan() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if (stream) {
        stream.getTracks().forEach((t) => t.stop());
        stream = null;
      }
      if (overlayCtx && overlay) overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      if (video) video.srcObject = null;
    }

    function scanFrame() {
      rafId = requestAnimationFrame(scanFrame);
      if (!video || video.readyState < 2 || !ctx) return;
      const now = Date.now();
      if (now - lastScanAt < 100) return;
      lastScanAt = now;

      syncCanvas();
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (overlayCtx) drawBox(code && code.location ? code.location : null);

      if (code && code.data) {
        const ok = showResult(code.data, true);
        if (ok) {
          beep();
          vibrate();
          stopScan();
        }
      }
    }

    function openScanner() {
      openModal();
      ensureAudio();
      setStatus(liveStatusEl, '');
      startScan();
    }

    function showResultModal(payload) {
      openModal();
      stopScan();
      resetViews();
      showResult(payload, false);
    }

    async function decodeFile(file) {
      if (!file || !ctx || !window.jsQR) return;
      setStatus(statusEl, qrStrings.reading, false);
      const img = new Image();
      img.onload = function () {
        canvas.width = img.naturalWidth || img.width;
        canvas.height = img.naturalHeight || img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (!code || !code.data) {
          setStatus(statusEl, qrStrings.notFound, true);
          return;
        }

        setStatus(statusEl, qrStrings.detected, false);
        showResultModal(code.data);
      };
      img.onerror = function () {
        setStatus(statusEl, 'Could not read that image. Try again.', true);
      };
      img.src = URL.createObjectURL(file);
    }

    if (openBtn) openBtn.addEventListener('click', openScanner);
    if (backdrop) backdrop.addEventListener('click', closeModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (rescanBtn) {
      rescanBtn.addEventListener('click', () => {
        setStatus(liveStatusEl, '');
        startScan();
      });
    }

    if (galIn) galIn.addEventListener('click', () => { galIn.value = ''; });
    if (galIn) galIn.addEventListener('change', (e) => decodeFile(e.target.files[0]));
  })();

  // Handle household forms with AJAX
  (function() {
    const createForm = document.getElementById('createHouseholdForm');
    const joinForm = document.getElementById('joinHouseholdForm');
    const qrJoinForm = document.getElementById('qrJoinForm');

    if (createForm) {
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = createForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '{{ t("setup.creating") }}';

        await submitFormAjax(createForm, {
          onRedirect: (url) => {
            window.location.href = url;
          },
          onError: () => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      });
    }

    async function handleJoinSubmit(form, errorEl) {
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '{{ t("setup.joining") }}';
      if (errorEl) {
        errorEl.classList.add('hidden');
        errorEl.textContent = '';
      }

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'same-origin'
        });

        if (response.ok && response.redirected) {
          window.location.href = response.url;
          return;
        }

        if (!response.ok) {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (errorEl && data.error) {
              errorEl.textContent = data.error;
              errorEl.classList.remove('hidden');
            }
          } else {
            if (errorEl) {
              errorEl.textContent = '{{ t("flash.invalid_join_code") }}';
              errorEl.classList.remove('hidden');
            }
          }
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          return;
        }

        // Success - redirect
        window.location.href = response.url || '{{ url_for("dashboard") }}';
      } catch (err) {
        console.error('Join error:', err);
        if (errorEl) {
          errorEl.textContent = 'Something went wrong. Please try again.';
          errorEl.classList.remove('hidden');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    if (joinForm) {
      const joinError = document.getElementById('joinError');
      const joinInput = document.getElementById('joinCodeInput');
      joinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleJoinSubmit(joinForm, joinError);
      });
      if (joinInput && joinError) {
        joinInput.addEventListener('input', () => {
          joinError.classList.add('hidden');
          joinError.textContent = '';
        });
      }
    }

    if (qrJoinForm) {
      const qrJoinError = document.getElementById('qrJoinError');
      qrJoinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleJoinSubmit(qrJoinForm, qrJoinError);
      });
    }
  })();
</script>
{% endblock %}
