{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-center px-4" style="min-height: calc(100vh - 160px); padding: 80px 1rem;">
  <div class="card rounded-3xl p-6 max-w-xl w-full text-center">
    <div class="mb-6">
      <svg class="w-20 h-20 mx-auto text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
    </div>
    <h1 class="text-3xl font-bold">{{ t('verify.title') }}</h1>
    <p class="mt-3 text-base text-slate-300">{{ t('verify.subtitle', email=current_user.email) }}</p>
    <p class="mt-2 text-sm text-slate-400">{{ t('verify.help') }}</p>

    <form id="verifyCodeForm" method="post" action="{{ url_for('verify_code') }}" class="mt-8">
      <div class="flex justify-center gap-2 sm:gap-3" dir="ltr">
        {% for i in range(6) %}
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]"
                 class="code-input w-12 h-14 sm:w-14 sm:h-16 text-center text-2xl sm:text-3xl font-bold rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
                 data-index="{{ i }}" autocomplete="off" />
        {% endfor %}
      </div>
      <input type="hidden" name="code" id="codeHidden" />

      <div id="verifyError" class="mt-4 text-sm text-rose-400 hidden"></div>

      <div id="verifyingIndicator" class="mt-6 hidden">
        <div class="flex items-center justify-center gap-2 text-violet-300">
          <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>{{ t('verify.verifying') }}</span>
        </div>
      </div>
    </form>

    <div class="mt-8 space-y-3">
      <p class="text-sm text-slate-400">
        {{ t('verify.didnt_receive') }}
      </p>
      <form method="post" action="{{ url_for('resend_verification') }}" id="resendForm">
        <button type="submit" id="resendBtn" class="w-full py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition font-semibold">
          {{ t('verify.resend_button') }}
        </button>
      </form>
      <a class="inline-flex items-center justify-center w-full py-3 rounded-2xl bg-white/5 hover:bg-white/10 transition text-sm font-medium text-slate-300"
         href="{{ url_for('logout') }}">
        {{ t('verify.logout_button') }}
      </a>
    </div>
  </div>
</div>

<script>
  (function() {
    const inputs = document.querySelectorAll('.code-input');
    const hiddenInput = document.getElementById('codeHidden');
    const form = document.getElementById('verifyCodeForm');
    const errorDiv = document.getElementById('verifyError');
    const verifyingIndicator = document.getElementById('verifyingIndicator');

    if (!inputs.length || !form) return;

    // Focus first input on load
    setTimeout(() => inputs[0].focus(), 100);

    function updateHiddenInput() {
      let code = '';
      inputs.forEach(input => {
        code += input.value;
      });
      hiddenInput.value = code;
      return code;
    }

    function clearError() {
      if (errorDiv) {
        errorDiv.classList.add('hidden');
        errorDiv.textContent = '';
      }
      inputs.forEach(input => input.classList.remove('ring-rose-500', 'border-rose-500'));
    }

    function showError(message) {
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
      inputs.forEach(input => input.classList.add('ring-rose-500', 'border-rose-500'));
    }

    async function submitCode() {
      const code = updateHiddenInput();
      if (code.length !== 6) return;

      clearError();
      verifyingIndicator.classList.remove('hidden');
      inputs.forEach(input => input.disabled = true);

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.redirected) {
          window.location.href = response.url;
          return;
        }

        // If not redirected, there was an error
        const text = await response.text();

        // Check if response contains error flash message
        if (text.includes('verification_code_invalid') || text.includes('incorrect') || response.status >= 400) {
          showError('{{ t("flash.verification_code_invalid") }}');
          inputs.forEach(input => {
            input.disabled = false;
            input.value = '';
          });
          inputs[0].focus();
          verifyingIndicator.classList.add('hidden');
        } else {
          // Redirect to the response URL
          window.location.href = response.url || '{{ url_for("dashboard") }}';
        }
      } catch (err) {
        showError('Something went wrong. Please try again.');
        inputs.forEach(input => {
          input.disabled = false;
          input.value = '';
        });
        inputs[0].focus();
        verifyingIndicator.classList.add('hidden');
      }
    }

    inputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        clearError();
        const value = e.target.value;

        // Only allow digits
        if (!/^\d*$/.test(value)) {
          e.target.value = value.replace(/\D/g, '');
          return;
        }

        // If a digit was entered, move to next input
        if (value.length === 1 && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }

        // Check if all inputs are filled
        const code = updateHiddenInput();
        if (code.length === 6) {
          submitCode();
        }
      });

      input.addEventListener('keydown', (e) => {
        // Handle backspace
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          inputs[index - 1].focus();
          inputs[index - 1].value = '';
        }

        // Handle arrow keys
        if (e.key === 'ArrowLeft' && index > 0) {
          e.preventDefault();
          inputs[index - 1].focus();
        }
        if (e.key === 'ArrowRight' && index < inputs.length - 1) {
          e.preventDefault();
          inputs[index + 1].focus();
        }
      });

      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

        if (pastedData.length > 0) {
          pastedData.split('').forEach((char, i) => {
            if (inputs[i]) {
              inputs[i].value = char;
            }
          });

          // Focus the next empty input or the last one
          const nextEmpty = Array.from(inputs).findIndex(inp => !inp.value);
          if (nextEmpty !== -1) {
            inputs[nextEmpty].focus();
          } else {
            inputs[inputs.length - 1].focus();
          }

          // Check if all inputs are filled
          const code = updateHiddenInput();
          if (code.length === 6) {
            submitCode();
          }
        }
      });

      // Select all on focus
      input.addEventListener('focus', () => {
        input.select();
      });
    });

    // Prevent form submission (we handle it via AJAX)
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      submitCode();
    });
  })();

  // Resend button cooldown
  (function() {
    const resendBtn = document.getElementById('resendBtn');
    const resendForm = document.getElementById('resendForm');
    const COOLDOWN_KEY = 'resend_cooldown_verify';
    const COOLDOWN_DURATION = 60; // seconds

    if (!resendBtn || !resendForm) return;

    function updateButton(secondsLeft) {
      if (secondsLeft > 0) {
        resendBtn.disabled = true;
        resendBtn.textContent = `{{ t('verify.resend_button') }} (${secondsLeft}s)`;
        resendBtn.classList.add('opacity-50', 'cursor-not-allowed');
        resendBtn.classList.remove('hover:bg-white/15');
      } else {
        resendBtn.disabled = false;
        resendBtn.textContent = '{{ t('verify.resend_button') }}';
        resendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        resendBtn.classList.add('hover:bg-white/15');
      }
    }

    function startCooldown() {
      const endTime = Date.now() + (COOLDOWN_DURATION * 1000);
      localStorage.setItem(COOLDOWN_KEY, endTime.toString());
      runCooldown();
    }

    function runCooldown() {
      const endTime = parseInt(localStorage.getItem(COOLDOWN_KEY) || '0');
      const now = Date.now();
      const secondsLeft = Math.ceil((endTime - now) / 1000);

      if (secondsLeft > 0) {
        updateButton(secondsLeft);
        setTimeout(runCooldown, 1000);
      } else {
        localStorage.removeItem(COOLDOWN_KEY);
        updateButton(0);
      }
    }

    // Check for existing cooldown on load
    const existingCooldown = localStorage.getItem(COOLDOWN_KEY);
    if (existingCooldown) {
      runCooldown();
    }

    // Handle resend form submission
    resendForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (resendBtn.disabled) return;

      const originalText = resendBtn.textContent;
      resendBtn.disabled = true;
      resendBtn.textContent = '{{ t("common.sending") }}...';

      try {
        const response = await fetch(resendForm.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
          startCooldown();
        } else {
          resendBtn.disabled = false;
          resendBtn.textContent = originalText;
        }
      } catch (err) {
        resendBtn.disabled = false;
        resendBtn.textContent = originalText;
      }
    });
  })();
</script>
{% endblock %}
